# Working with Import Set API in ServiceNow

[[Overview]](#overview)  [[Operation details]](#operation-details)  [[Sample configuration]](#sample-configuration)

### Overview 

The following operations allow you to work with  Import Set API. Click an operation name to see details on how to use it.
For a sample REST API that illustrates how to work with  Import Set API, see [Sample configuration](#sample-configuration).

| Operation        | Description |
| ------------- |-------------|
| [getRecordsStagingTable](#Retrieving-the-record)    | This method retrieves the specified import staging record and resulting transformation result.|
| [postRecordStagingTableInsertMultiple](#Inserts-multiple-records-into-the-staging-table)      | This method inserts multiple records into a specified staging table and triggers transformation |
| [postRecordStagingTable](#Inserts-incoming-data-into-a-specified-staging-table)      | This method inserts incoming data into a specified staging table and triggers transformation. |


### Operation details

This section provides more details on each of the operations related to Import Set API.

#### Retrieving the record

The getRecordStagingTable operation retrieves the associated record and resulting transformation result.

**getRecordsStagingTable**
```xml
<servicenow.getRecordsStagingTable>
    <stagingTableName>{$ctx:stagingTableName}</stagingTableName>
    <apiVersion>{$ctx:apiVersion}</apiVersion>
    <sysIdStaging>{$ctx:sysIdStaging}</sysIdStaging>
</servicenow.getRecordsStagingTable>
```
**Properties**

* stagingTableName :  Name of the staging table for retrieving records.
* sysIdStaging :  The Id which is automatically generated by ServiceNow. It is a unique value for each record.
* apiVersion : Optinal api versin to be embeded in the url.

**Sample request**

Following is a sample request that can be handled by the getRecordsStagingTable operation.

```json

{

  "stagingTableName":"imp_computer",
  "sysIdStaging":"e2928be64f411200adf9f8e18110c777"

}
```
**Sample response**

Given below is a sample response for the getRecordsStagingTable operation.

```json
{
  "import_set": "ISET0010001",
  "staging_table": "imp_user",
  "result": [
    {
      "transform_map": "User",
      "table": "sys_user",
      "display_name": "name",
      "display_value": "John Public",
      "record_link": "https://instance.service-now.com/api/now/table/sys_user/ea928be64f411200adf9f8e18110c777",
      "status": "inserted",
      "sys_id": "ea928be64f411200adf9f8e18110c777"
    }
  ]
}
```

**Related ServiceNow documentation**

https://developer.servicenow.com/dev.do#!/reference/api/utah/rest/c_ImportSetAPI#import-GET

#### Inserts multiple records into the staging table

Inserts multiple records into a specified staging table and triggers transformation based on predefined transform maps or Robust Transform Engine (RTE) configurations in a single request.

**postRecordStagingTableInsertMultiple**
```xml
<servicenow.postRecordStagingTableInsertMultiple>
   <stagingTableName>{$ctx:stagingTableName}</stagingTableName>
   <apiVersion>{$ctx:apiVersion}</apiVersion>
   <multiImportSetId>{$ctx:multiImportSetId}</multiImportSetId>
   <runAfter>{$ctx:runAfter}</runAfte> 
 </servicenow.postRecordStagingTableInsertMultiple>
```
**Properties**
* stagingTableName :  Name of the staging table for retrieving records..
* apiVersion : Optinal api versin to be embeded in the url.
* multiImportSetId : Sys_id of an entry in the Multi Import Sets [sys_multi_import_set] table.
* runAfter : Sys_id of an entry in the Import Sets [sys_import_set] table.


**Sample request**

Following is a sample request that can be handled by the postRecordStagingTable operation.

```json
{
   "records ": [
  {
    "Address ":  "Hollywood ",
    "Name ":  "Tom ",
    "ID ":  "123 "
  },
  {
    "Address ":  "Vine ",
    "Name ":  "Irene ",
    "ID ":  "456 "
  }
  ]
}
```
**Sample response**

Given below is a sample response for the postRecordStagingTable operation.

```json
{
  "import_set_id": "<import_set_sys_id>",
  "multi_import_set_id": "<multi_import_set_sys_id>"
}

```

**Related ServiceNow documentation**
https://developer.servicenow.com/dev.do#!/reference/api/utah/rest/c_ImportSetAPI#import-POST-insertMultiple


**NOTE**

You have to give Access Control List (ACL) permission to access the records in import set tables. You can find more information on https://docs.servicenow.com/bundle/utah-security-management/page/product/secops-integration-major-security-incident-management/task/adding-access-control-lists-for-msim-workspace-users.html

#### Inserts records into the staging table

Inserts incoming data into a specified staging table and triggers transformation based on predefined transform maps in the import set table.

**postRecordStagingTable**
```xml
<servicenow.postRecordStagingTableInsertMultiple>
   <stagingTableName>{$ctx:stagingTableName}</stagingTableName>
   <apiVersion>{$ctx:apiVersion}</apiVersion>
 </servicenow.postRecordStagingTableInsertMultiple>
```
**Properties**
* stagingTableName :  Name of the staging table for retrieving records..
* apiVersion : Optinal api versin to be embeded in the url.


**Sample request**

Following is a sample request that can be handled by the postRecordStagingTable operation.

```json

{

  "stagingTableName":"imp_computer",
  "serial_number":"282",
  "name":"Mac",
  "operating_system":"ubunthu",
  "manufacturer":"IBM",
  "ram":"ram 1500",
  "apiColumns": {"sys_mod_count":"2","sys_import_state_comment":"wwww"}

}

```
**Sample response**

Given below is a sample response for the postRecordStagingTable operation.

```json
{
    "import_set": "ISET0010007",
    "staging_table": "imp_computer",
    "result": [
        {
            "transform_map": "Computer",
            "table": "cmdb_ci_computer",
            "display_name": "name",
            "display_value": "Mac",
            "record_link": "https://dev212092.service-now.com/api/now/table/cmdb_ci_computer/1ac94e3f93000210e1dd70718bba10d0",
            "status": "inserted",
            "sys_id": "1ac94e3f93000210e1dd70718bba10d0"
        }
    ]
}

```

**Related ServiceNow documentation**
https://developer.servicenow.com/dev.do#!/reference/api/utah/rest/c_ImportSetAPI#import-POST

### Sample configuration

Following example illustrates how to connect to ServiceNow with the init operation and postRecordsStagingTable operation.

1. Create a sample proxy as below :

```xml
<?xml version="1.0" encoding="UTF-8"?>
<api context="/importset" name="ImportSetAPI" xmlns="http://ws.apache.org/ns/synapse">
    <resource methods="POST" uri-template="/postrecord">
        <inSequence>
            <servicenow.init>
                <serviceNowInstanceURL>https://your-instance.service-now.com</serviceNowInstanceURL>
                <username>admin</username>
                <password>your-passord</password>
            </servicenow.init>
            <servicenow.postRecordStagingTable>
                <stagingTableName>{json-eval($.stagingTableName)}</stagingTableName>
                <apiVersion>{json-eval($.apiVersion)}</apiVersion>
            </servicenow.postRecordStagingTable>
            <respond/>
        </inSequence>
        <outSequence/>
        <faultSequence/>
    </resource>
</api>

```

2. Create a JSON file named postRecordsStagingTable.json and add the configurations given below:

```json

{

  "stagingTableName":"imp_computer",
  "serial_number":"282",
  "name":"Mac",
  "operating_system":"ubunthu",
  "manufacturer":"IBM",
  "ram":"ram 1500",
  "apiColumns": {"sys_mod_count":"2","sys_import_state_comment":"wwww"}

}
```
3. Replace the credentials with your values.

4. Execute the following curl command:

```bash
curl http://localhost:8290/importset/postrecord -H "Content-Type: application/json" -d @getRecordsStagingTable.json
```

5. ServiceNow returns a JSON response similar to the one shown below:
 
```json
{
    "import_set": "ISET0010007",
    "staging_table": "imp_computer",
    "result": [
        {
            "transform_map": "Computer",
            "table": "cmdb_ci_computer",
            "display_name": "name",
            "display_value": "Mac",
            "record_link": "https://dev212092.service-now.com/api/now/table/cmdb_ci_computer/a127967b93400210e1dd70718bba108d",
            "status": "inserted",
            "sys_id": "a127967b93400210e1dd70718bba108d"
        }
    ]
}
```
